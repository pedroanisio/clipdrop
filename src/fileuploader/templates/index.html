{% extends "base.html" %}

{% block title %}File Upload{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-cloud-upload-alt" aria-hidden="true"></i> Upload a file</h1>
<p>Allowed file types: {{ allowed_extensions | join(', ') }}</p>

{% with messages = get_flashed_messages(with_categories=True) %}
  {% if messages %}
    <div class="mb-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {% if category == 'success' %}
            <i class="fas fa-check-circle mr-2" aria-hidden="true"></i>
          {% elif category == 'danger' %}
            <i class="fas fa-times-circle mr-2" aria-hidden="true"></i>
          {% elif category == 'warning' %}
            <i class="fas fa-exclamation-triangle mr-2" aria-hidden="true"></i>
          {% else %}
            <i class="fas fa-info-circle mr-2" aria-hidden="true"></i>
          {% endif %}
          <span>{{ message }}</span>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Upload Form -->
<div class="mb-4">
    <form id="upload-form" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <input type="file" name="file" id="file-input" class="form-control-file d-none">
        </div>
        <div id="drag-drop-area" class="drag-drop-area">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3" aria-hidden="true"></i>
            <p>Drag & Drop files here or click to select files</p>
        </div>
        <div id="upload-progress" class="progress progress-lg mt-3" style="display: none;">
            <div id="progress-bar" class="progress-bar is-animated"
                 role="progressbar"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="100"
                 aria-label="Upload progress">
                0%
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">
            <i class="fas fa-upload" aria-hidden="true"></i> Upload
        </button>
    </form>
</div>

<!-- Files Table -->
<h2><i class="fas fa-folder-open" aria-hidden="true"></i> Files available for download:</h2>
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Type</th>
                <th>File Name</th>
                <th>Size</th>
                <th>Creation Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td>
                    {% if file.extension in ['png', 'jpg', 'jpeg', 'gif'] %}
                        <i class="fas fa-file-image text-info" aria-hidden="true"></i>
                        <span class="sr-only">Image file</span>
                    {% elif file.extension == 'pdf' %}
                        <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i>
                        <span class="sr-only">PDF file</span>
                    {% elif file.extension == 'txt' %}
                        <i class="fas fa-file-alt text-secondary" aria-hidden="true"></i>
                        <span class="sr-only">Text file</span>
                    {% elif file.extension == 'pst' %}
                        <i class="fas fa-envelope text-warning" aria-hidden="true"></i>
                        <span class="sr-only">Outlook PST file</span>
                    {% else %}
                        <i class="fas fa-file text-muted" aria-hidden="true"></i>
                        <span class="sr-only">File</span>
                    {% endif %}
                </td>
                <td class="filename-cell" title="{{ file.name }}">{{ file.name }}</td>
                <td>{{ file.size_human }}</td>
                <td>{{ file.creation_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    <div class="btn-group-actions">
                        <a href="{{ url_for('uploaded_file', filename=file.name) }}" class="btn btn-info btn-sm" aria-label="Download {{ file.name }}">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </a>
                        <button class="btn btn-success btn-sm share-btn" data-url="{{ url_for('uploaded_file', filename=file.name, _external=True) }}" aria-label="Share {{ file.name }}">
                            <i class="fas fa-share-alt" aria-hidden="true"></i>
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file.name }}" data-type="file" aria-label="Delete {{ file.name }}">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Clipboard Section -->
<div class="clipboard-area">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"><i class="fas fa-clipboard" aria-hidden="true"></i> Clipboard</h2>
        <a href="{{ url_for('shared_clipboard') }}" class="btn btn-outline-primary">
            <i class="fas fa-external-link-alt" aria-hidden="true"></i> Open Shared Clipboard
        </a>
    </div>
    <form id="clipboard-form" method="post">
        <div class="form-group">
            <label for="clipboard-text" class="sr-only">Clipboard text</label>
            <textarea id="clipboard-text" class="form-control" rows="3" placeholder="Paste text here..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save" aria-hidden="true"></i> Save Clipboard
        </button>
    </form>
    <div id="clipboard-cards">
        {% for file in clipboard_files %}
        <div class="card" id="clipboard-{{ loop.index }}">
            <div class="card-body">
                <h5 class="card-title">
                    {% if file.extension in ['png', 'jpg', 'jpeg', 'gif'] %}
                        <i class="fas fa-file-image text-info" aria-hidden="true"></i>
                    {% else %}
                        <i class="fas fa-file-alt text-secondary" aria-hidden="true"></i>
                    {% endif %}
                    <span class="filename-truncate" title="{{ file.name }}">{{ file.name }}</span>
                </h5>
                <div class="btn-group">
                    {% if file.name.endswith('.txt') %}
                    <button class="btn btn-secondary btn-sm" type="button" data-toggle="collapse" data-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                        <i class="fas fa-eye" aria-hidden="true"></i> View
                    </button>
                    {% endif %}
                    <a href="{{ url_for('clipboard_file_raw', filename=file.name) }}" class="btn btn-info btn-sm" aria-label="Download {{ file.name }}">
                        <i class="fas fa-download" aria-hidden="true"></i>
                    </a>
                    <button class="btn btn-success btn-sm share-btn" data-url="{{ url_for('clipboard_file', filename=file.name, _external=True) }}" aria-label="Share {{ file.name }}">
                        <i class="fas fa-share-alt" aria-hidden="true"></i>
                    </button>
                    {% if file.name.endswith('.txt') %}
                    <button class="btn btn-secondary btn-sm copy-btn" data-text="{{ file.content | e }}" aria-label="Copy {{ file.name }}">
                        <i class="fas fa-copy" aria-hidden="true"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file.name }}" data-type="clipboard" aria-label="Delete {{ file.name }}">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                    </button>
                </div>
                {% if file.name.endswith('.txt') %}
                <div class="collapse" id="collapse{{ loop.index }}">
                    <div class="card card-body mt-2">
                        <pre>{{ file.content | e }}</pre>
                    </div>
                </div>
                {% endif %}
                {% if not file.name.endswith('.txt') %}
                <img src="{{ url_for('clipboard_file_raw', filename=file.name) }}" class="card-img-top mt-2" alt="Clipboard image: {{ file.name }}">
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('file-input');
    const dragDropArea = document.getElementById('drag-drop-area');
    const uploadForm = document.getElementById('upload-form');
    const clipboardForm = document.getElementById('clipboard-form');
    const clipboardText = document.getElementById('clipboard-text');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');

    dragDropArea.addEventListener('click', () => fileInput.click());

    // Upload with progress bar
    function uploadWithProgress(files) {
        const formData = new FormData();
        formData.append('file', files[0]);

        uploadProgress.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                progressBar.setAttribute('aria-valuenow', percentComplete);
            }
        });

        xhr.addEventListener('load', () => {
            const response = xhr.response || {};
            if (xhr.status >= 200 && xhr.status < 300 && response.status === 'success') {
                showToast(response.message || 'File successfully uploaded!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(response.message || 'Upload failed. Please try again.', 'error');
                uploadProgress.style.display = 'none';
            }
        });

        xhr.addEventListener('error', () => {
            showToast('Upload failed. Please try again.', 'error');
            uploadProgress.style.display = 'none';
        });

        xhr.open('POST', '/');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.responseType = 'json';
        xhr.send(formData);
    }

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            uploadWithProgress(fileInput.files);
        }
    });

    dragDropArea.addEventListener('dragover', (event) => {
        event.preventDefault();
        dragDropArea.classList.add('drag-over');
    });

    dragDropArea.addEventListener('dragleave', () => {
        dragDropArea.classList.remove('drag-over');
    });

    dragDropArea.addEventListener('drop', (event) => {
        event.preventDefault();
        dragDropArea.classList.remove('drag-over');
        if (event.dataTransfer.files.length > 0) {
            uploadWithProgress(event.dataTransfer.files);
        }
    });

    clipboardForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData();
        formData.append('clipboard_data', clipboardText.value);
        const response = await fetch('/clipboard', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.status === 'success') {
            showToast('Clipboard saved!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(result.message, 'error');
        }
    });

    // Copy to clipboard
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const text = event.currentTarget.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => {
                showToast('Text copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy text.', 'error');
            });
        });
    });

    // Share button - copy URL
    document.querySelectorAll('.share-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const url = event.currentTarget.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy link.', 'error');
            });
        });
    });

    // Delete functionality
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', async (event) => {
            const filename = event.currentTarget.getAttribute('data-filename');
            const type = event.currentTarget.getAttribute('data-type');

            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            const url = type === 'clipboard' ? `/delete/clipboard/${filename}` : `/delete/${filename}`;

            try {
                const response = await fetch(url, { method: 'DELETE' });
                const result = await response.json();

                if (result.status === 'success') {
                    showToast('Item deleted successfully!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message || 'Failed to delete item.', 'error');
                }
            } catch (error) {
                showToast('Failed to delete item.', 'error');
            }
        });
    });
</script>
{% endblock %}
